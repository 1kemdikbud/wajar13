<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Aplikasi Observasi Satuan Pendidikan</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; }
        .view { transition: opacity 0.3s ease-in-out, transform 0.3s ease-in-out; }
        .modal-backdrop { transition: opacity 0.3s ease; }
        .modal-content { transition: transform 0.3s ease; }
        .hidden-view { opacity: 0; transform: scale(0.98); pointer-events: none; position: absolute; }
        th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid #e5e7eb; }
        tbody tr:nth-child(odd) { background-color: #f9fafb; }
        thead { position: sticky; top: 0; background-color: #f3f4f6; }
        .nav-button {
            transition: all 0.2s ease-in-out;
            border-bottom: 4px solid transparent;
        }
        .nav-button.active {
            border-bottom-color: #14b8a6; /* teal-500 */
            color: #0d9488; /* teal-600 */
        }
        
        /* Print Styles for Individual Report */
        @media print {
            .print-individual-report body * { visibility: hidden; }
            .print-individual-report #print-content-area, .print-individual-report #print-content-area * { visibility: visible; }
            .print-individual-report #printPreviewModal { position: absolute; left: 0; top: 0; width: 100%; height: auto; overflow: visible; background-color: white; padding: 0; }
            .print-individual-report #print-content-area { position: absolute; left: 0; top: 0; width: 100%; padding: 1.5cm; font-size: 11pt; color: #000; }
            .print-individual-report .print-section { margin-bottom: 1.25rem; break-inside: avoid; }
            .print-individual-report .print-section-title { font-size: 1.1rem; font-weight: 600; border-bottom: 2px solid #ccc; padding-bottom: 0.4rem; margin-bottom: 0.8rem; }
            .print-individual-report .print-item { margin-bottom: 0.5rem; }
            .print-individual-report .print-item-grouped { border-top: 1px solid #eee; padding-top: 0.75rem; margin-top: 0.75rem; }
            .print-individual-report .print-item-label { font-weight: 600; margin-bottom: 0.25rem; }
            
            /* Print Styles for Aggregated Report */
            .print-aggregated-report body > *:not(#printable-report-area) { display: none; }
            .print-aggregated-report #printable-report-area {
                visibility: visible !important;
                position: absolute;
                left: 0;
                top: 0;
                width: 100%;
                padding: 1.5cm;
                font-size: 11pt;
            }
             .print-aggregated-report .print-hide { display: none !important; }
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div class="container mx-auto p-4 sm:p-6 lg:p-8 max-w-7xl">
        
        <header class="text-center mb-8 bg-white p-6 rounded-xl shadow-md print-hide">
            <h1 class="text-3xl font-bold text-gray-700">Aplikasi Observasi Satuan Pendidikan</h1>
            <p class="text-gray-500 mt-2">Pilih menu di bawah untuk mengisi formulir atau melihat laporan.</p>
            <nav class="flex justify-center items-center gap-4 sm:gap-8 mt-6 border-t pt-4">
                <button id="nav-form-btn" class="nav-button active text-lg font-semibold py-2 px-4 text-gray-600 hover:text-teal-600">
                    <i class="fas fa-edit mr-2"></i>Input Formulir
                </button>
                <button id="nav-report-btn" class="nav-button text-lg font-semibold py-2 px-4 text-gray-600 hover:text-teal-600">
                    <i class="fas fa-chart-bar mr-2"></i>Laporan Observasi
                </button>
                <button id="nav-stats-btn" class="nav-button text-lg font-semibold py-2 px-4 text-gray-600 hover:text-teal-600">
                    <i class="fas fa-percentage mr-2"></i>Statistik Daerah
                </button>
				<a href="./" class="nav-button text-lg font-semibold py-2 px-4 text-gray-700 hover:text-red-600" data-target="home"><i class="fas fa-home mr-2"></i></a>
            </nav>
        </header>
        
        <main class="relative">
            <!-- Form View -->
            <div id="form-view" class="view">
                <form id="observasiForm" class="bg-white p-8 rounded-xl shadow-lg space-y-8 max-w-4xl mx-auto">
                    <fieldset class="form-section border-t-4 border-teal-500 pt-6">
                        <legend class="text-xl font-semibold text-gray-700 px-2">DATA PETUGAS SUPERVISI</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                            <div>
                                <label for="kota_kabupaten" class="block text-sm font-medium text-gray-600 mb-1">Kota/Kabupaten</label>
                                <select id="kota_kabupaten" name="kota_kabupaten" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm" required>
                                    <option value="" disabled selected>Pilih Kota/Kabupaten...</option>
                                    <option value="Kota Adm Jakarta Barat">Kota Adm Jakarta Barat</option>
                                    <option value="Kabupaten Tasikmalaya">Kabupaten Tasikmalaya</option>
                                    <option value="Kabupaten Klaten">Kabupaten Klaten</option>
                                    <option value="Kota Surabaya">Kota Surabaya</option>
                                    <option value="Kota Malang">Kota Malang</option>
                                    <option value="Kabupaten Musi Banyuasin">Kabupaten Musi Banyuasin</option>
                                    <option value="Kabupaten Pesawaran">Kabupaten Pesawaran</option>
                                    <option value="Kabupaten Katingan">Kabupaten Katingan</option>
                                    <option value="Kabupaten Banjar">Kabupaten Banjar</option>
                                    <option value="Kota Bitung">Kota Bitung</option>
                                    <option value="Kabupaten Sigi">Kabupaten Sigi</option>
                                    <option value="Kota Palu">Kota Palu</option>
                                    <option value="Kabupaten Lombok Barat">Kabupaten Lombok Barat</option>
                                    <option value="Kota Serang">Kota Serang</option>
                                    <option value="Kabupaten Pohuwato">Kabupaten Pohuwato</option>
                                </select>
                            </div>
                            <div>
                                <label for="nama_petugas" class="block text-sm font-medium text-gray-600 mb-1">Nama Petugas Supervisi</label>
                                <input type="text" id="nama_petugas" name="nama_petugas" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm" required>
                            </div>
                            <div>
                                <label for="no_hp_petugas" class="block text-sm font-medium text-gray-600 mb-1">No. HP Petugas</label>
                                <input type="tel" id="no_hp_petugas" name="no_hp_petugas" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm" required>
                            </div>
                        </div>
                    </fieldset>
                    <fieldset class="form-section border-t-4 border-indigo-500 pt-6">
                        <legend class="text-xl font-semibold text-gray-700 px-2">DATA RESPONDEN</legend>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                            <div>
                                <label for="nama_responden" class="block text-sm font-medium text-gray-600 mb-1">Nama Responden</label>
                                <input type="text" id="nama_responden" name="nama_responden" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm" required>
                            </div>
                            <div class="md:col-span-2">
                                <label for="nama_satuan_pendidikan" class="block text-sm font-medium text-gray-600 mb-1">Nama Satuan Pendidikan</label>
                                <input type="text" id="nama_satuan_pendidikan" name="nama_satuan_pendidikan" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm" required>
                            </div>
                            <div class="md:col-span-2">
                                <label for="alamat_satuan_pendidikan" class="block text-sm font-medium text-gray-600 mb-1">Alamat Satuan Pendidikan</label>
                                <textarea id="alamat_satuan_pendidikan" name="alamat_satuan_pendidikan" rows="3" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm" required></textarea>
                            </div>
                            <div>
                                <label for="nama_kepala_sekolah" class="block text-sm font-medium text-gray-600 mb-1">Nama Kepala Sekolah</label>
                                <input type="text" id="nama_kepala_sekolah" name="nama_kepala_sekolah" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm" required>
                            </div>
                            <div>
                                <label for="no_hp_kepala_sekolah" class="block text-sm font-medium text-gray-600 mb-1">No. HP Kepala Sekolah</label>
                                <input type="tel" id="no_hp_kepala_sekolah" name="no_hp_kepala_sekolah" class="w-full px-4 py-2 border border-gray-300 rounded-md shadow-sm" required>
                            </div>
                        </div>
                    </fieldset>
                    <div id="question-sections-container"></div>
                    <div id="navigation-controls" class="flex justify-between items-center pt-6 border-t mt-8">
                        <button type="button" id="prev-button" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-6 rounded-lg">Sebelumnya</button>
                        <button type="button" id="next-button" class="bg-teal-500 hover:bg-teal-600 text-white font-bold py-2 px-6 rounded-lg">Berikutnya</button>
                        <button type="submit" id="submit-button" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-3 px-8 rounded-lg shadow-md hidden"><span id="button-text">Kirim Data</span><i id="loading-spinner" class="fas fa-spinner fa-spin ml-2 hidden"></i></button>
                    </div>
                </form>
            </div>

            <!-- Report View -->
            <div id="report-view" class="view hidden-view">
                 <div class="bg-white p-8 rounded-xl shadow-lg">
                    <div id="printable-report-area">
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 print-hide">
                            <h2 class="text-2xl font-bold text-gray-700 mb-2 sm:mb-0">Laporan Agregat Observasi</h2>
                            <div class="flex items-center gap-4 w-full sm:w-auto">
                                <div class="w-full sm:w-auto">
                                    <label for="region-filter" class="block text-sm font-medium text-gray-600 mb-1">Pilih Daerah:</label>
                                    <select id="region-filter" class="w-full sm:w-64 px-4 py-2 border border-gray-300 rounded-md shadow-sm">
                                        <option value="semua">Semua Daerah</option>
                                    </select>
                                </div>
                                <button id="print-report-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg self-end hidden">
                                    <i class="fas fa-print mr-2"></i>Cetak
                                </button>
                            </div>
                        </div>
                        <div id="report-content-wrapper">
                            <!-- Content (info and table) will be injected here -->
                        </div>
                    </div>
                 </div>
            </div>

            <!-- Stats View -->
            <div id="stats-view" class="view hidden-view">
                <div class="bg-white p-8 rounded-xl shadow-lg space-y-12">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-700 mb-6">Visualisasi Status Input Daerah</h2>
                        <div class="max-w-xs mx-auto">
                            <canvas id="inputChart"></canvas>
                        </div>
                    </div>
                    <div class="border-t pt-8">
                        <h2 class="text-2xl font-bold text-gray-700 mb-6">Tabel Status Input Daerah</h2>
                        <div id="status-table-container"></div>
                    </div>
                     <div class="border-t pt-8">
                        <h2 class="text-2xl font-bold text-gray-700 mb-6">Statistik Kelengkapan Input per Daerah</h2>
                        <div id="stats-container" class="overflow-x-auto"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Response Modal -->
    <div id="responseModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop hidden z-50 opacity-0">
        <div class="bg-white rounded-lg shadow-xl p-8 max-w-sm w-full text-center modal-content scale-95">
            <div id="modal-icon" class="mx-auto flex items-center justify-center h-16 w-16 rounded-full mb-4"></div>
            <h3 id="modal-title" class="text-2xl font-semibold text-gray-800"></h3>
            <p id="modal-message" class="text-gray-600 mt-2 mb-6"></p>
            <div class="flex justify-center gap-4">
                 <button id="modal-close" class="bg-gray-500 hover:bg-gray-600 text-white font-bold py-2 px-6 rounded-lg">Tutup</button>
                 <button id="modal-print-preview-btn" class="bg-teal-600 hover:bg-teal-700 text-white font-bold py-2 px-6 rounded-lg hidden">
                    <i class="fas fa-print mr-2"></i>Lihat Laporan
                </button>
            </div>
        </div>
    </div>

    <!-- Print Preview Modal (Individual) -->
    <div id="printPreviewModal" class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 modal-backdrop hidden z-[60] opacity-0">
        <div class="bg-white rounded-lg shadow-xl w-full max-w-4xl h-[90vh] flex flex-col modal-content scale-95">
            <header class="p-4 border-b flex justify-between items-center print-hide">
                <h3 class="text-xl font-semibold text-gray-800">Pratinjau Laporan Observasi</h3>
                <div class="flex gap-4">
                    <button id="print-button" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg">
                        <i class="fas fa-print mr-2"></i>Cetak PDF
                    </button>
                    <button id="print-modal-close" class="bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-2 px-4 rounded-lg">Tutup</button>
                </div>
            </header>
            <main id="print-content-area" class="p-8 overflow-y-auto">
                <!-- Content will be injected here by JavaScript -->
            </main>
        </div>
    </div>


    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const scriptURL = 'https://script.google.com/macros/s/AKfycbyjWKPkPs8dUl2cQnmEQwpxcjbxE0bSlibVmfsJTwS-Do_iYBdh0c7-Rw3X4bISaHEdlg/exec';
        
        // --- Bagian Form ---
        const form = document.getElementById('observasiForm');
        const submitButton = document.getElementById('submit-button');
        const buttonText = document.getElementById('button-text');
        const loadingSpinner = document.getElementById('loading-spinner');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const questionContainer = document.getElementById('question-sections-container');
        const masterData = [
            { id: 'kota_kabupaten', type: 'select' }, { id: 'nama_petugas', type: 'text' }, { id: 'no_hp_petugas', type: 'tel' }, { id: 'nama_responden', type: 'text' }, { id: 'nama_satuan_pendidikan', type: 'text' }, { id: 'alamat_satuan_pendidikan', type: 'textarea' }, { id: 'nama_kepala_sekolah', type: 'text' }, { id: 'no_hp_kepala_sekolah', type: 'tel' },
            { id: 'akses_q1', type: 'radio', text: '1. Apakah ada upaya yang dilakukan sekolah dalam mencegah Anak Berisiko Putus Sekolah (ABPS)?' }, { id: 'akses_q1_note', type: 'textarea' },
            { id: 'akses_q2', type: 'radio', text: '2. Apakah ada dukungan/bantuan yang diberikan oleh pihak sekolah atau dinas dalam mencegah Anak Berisiko Putus Sekolah (ABPS)?' }, { id: 'akses_q2_note', type: 'textarea' },
            { id: 'akses_q3', type: 'radio', text: '3. Apakah fasilitas ramah anak dan ramah disabilitas tetap dipelihara dengan baik?' }, { id: 'akses_q3_note', type: 'textarea' },
            { id: 'akses_q4', type: 'radio', text: '4. Apakah sekolah memiliki inovasi layanan akses (misalnya kelas tambahan, transportasi, atau program khusus)?' }, { id: 'akses_q4_note', type: 'textarea' },
            { id: 'akses_q5', type: 'radio', text: '5. Apakah ada pengalaman sekolah dalam mempertahankan APS tinggi sudah didokumentasikan dan disebarluaskan untuk replikasi?' }, { id: 'akses_q5_note', type: 'textarea' },
            { id: 'mutu_q1', type: 'radio', text: '1. Apakah guru menerapkan metode pembelajaran inovatif (digital, tematik, berbasis proyek) yang menjaga mutu meski ATS rendah?' }, { id: 'mutu_q1_note', type: 'textarea' },
            { id: 'mutu_q2', type: 'radio', text: '2. Apakah program literasi dan numerasi berjalan konsisten dan hasilnya terukur?' }, { id: 'mutu_q2_note', type: 'textarea' },
            { id: 'mutu_q3', type: 'radio', text: '3. Apakah kegiatan ekstrakurikuler mendukung prestasi akademik dan non-akademik siswa?' }, { id: 'mutu_q3_note', type: 'textarea' },
            { id: 'mutu_q4', type: 'radio', text: '4. Apakah sekolah memiliki program unggulan yang memperkuat Profil Pelajar Pancasila?' }, { id: 'mutu_q4_note', type: 'textarea' },
            { id: 'mutu_q5', type: 'radio', text: '5. Apakah praktik mutu pembelajaran sekolah ini sudah dibagikan ke sekolah lain (forum MGMP/KKG)?' }, { id: 'mutu_q5_note', type: 'textarea' },
            { id: 'tata_kelola_q1', type: 'radio', text: '1. Apakah kepala sekolah aktif menjaga stabilitas APS dan mutu layanan pendidikan?' }, { id: 'tata_kelola_q1_note', type: 'textarea' },
            { id: 'tata_kelola_q2', type: 'radio', text: '2. Apakah sekolah memiliki strategi keberlanjutan program meski tanpa intervensi eksternal?' }, { id: 'tata_kelola_q2_note', type: 'textarea' },
            { id: 'tata_kelola_q3', type: 'radio', text: '3. Apakah transparansi dana BOS tetap dijaga meskipun sekolah sudah stabil (APS bagus)?' }, { id: 'tata_kelola_q3_note', type: 'textarea' },
            { id: 'tata_kelola_q4', type: 'radio', text: '4. Apakah keterlibatan orang tua/komite sekolah sudah menjadi budaya dalam tata kelola?' }, { id: 'tata_kelola_q4_note', type: 'textarea' },
            { id: 'tata_kelola_q5', type: 'radio', text: '5. Apakah tata kelola yang berhasil di sekolah ini sudah menjadi rujukan/replikasi bagi sekolah lain?' }, { id: 'tata_kelola_q5_note', type: 'textarea' }
        ];
        const reportHeaders = [
            "Timestamp", "Kota/Kabupaten", "Nama Petugas Supervisi", "No. HP Petugas", "Nama Responden", "Nama Satuan Pendidikan", "Alamat Satuan Pendidikan", "Nama Kepala Sekolah", "No HP Kepala Sekolah",
            "1. Apakah ada upaya yang dilakukan sekolah dalam mencegah Anak Berisiko Putus Sekolah (ABPS)?", "1a. Catatan Tambahan",
            "2. Apakah ada dukungan/bantuan yang diberikan oleh pihak sekolah atau dinas dalam mencegah Anak Berisiko Putus Sekolah (ABPS)?", "2a. Catatan Tambahan",
            "3. Apakah fasilitas ramah anak dan ramah disabilitas tetap dipelihara dengan baik?", "3a. Catatan Tambahan",
            "4. Apakah sekolah memiliki inovasi layanan akses (misalnya kelas tambahan, transportasi, atau program khusus)?", "4a. Catatan Tambahan",
            "5. Apakah ada pengalaman sekolah dalam mempertahankan APS tinggi sudah didokumentasikan dan disebarluaskan untuk replikasi?", "5a. Catatan Tambahan",
            "1. Apakah guru menerapkan metode pembelajaran inovatif (digital, tematik, berbasis proyek) yang menjaga mutu meski ATS rendah?", "1a. Catatan Tambahan",
            "2. Apakah program literasi dan numerasi berjalan konsisten dan hasilnya terukur?", "2a. Catatan Tambahan",
            "3. Apakah kegiatan ekstrakurikuler mendukung prestasi akademik dan non-akademik siswa?", "3a. Catatan Tambahan",
            "4. Apakah sekolah memiliki program unggulan yang memperkuat Profil Pelajar Pancasila?", "4a. Catatan Tambahan",
            "5. Apakah praktik mutu pembelajaran sekolah ini sudah dibagikan ke sekolah lain (forum MGMP/KKG)?", "5a. Catatan Tambahan",
            "1. Apakah kepala sekolah aktif menjaga stabilitas APS dan mutu layanan pendidikan?", "1a. Catatan Tambahan",
            "2. Apakah sekolah memiliki strategi keberlanjutan program meski tanpa intervensi eksternal?", "2a. Catatan Tambahan",
            "3. Apakah transparansi dana BOS tetap dijaga meskipun sekolah sudah stabil (APS bagus)?", "3a. Catatan Tambahan",
            "4. Apakah keterlibatan orang tua/komite sekolah sudah menjadi budaya dalam tata kelola?", "4a. Catatan Tambahan",
            "5. Apakah tata kelola yang berhasil di sekolah ini sudah menjadi rujukan/replikasi bagi sekolah lain?", "5a. Catatan Tambahan"
        ];
        let allSections, currentSectionIndex = 0;
        
        // --- Bagian Navigasi & Tampilan ---
        const views = { form: document.getElementById('form-view'), report: document.getElementById('report-view'), stats: document.getElementById('stats-view') };
        const navButtons = { form: document.getElementById('nav-form-btn'), report: document.getElementById('nav-report-btn'), stats: document.getElementById('nav-stats-btn') };
        const reportContentWrapper = document.getElementById('report-content-wrapper');
        const printReportBtn = document.getElementById('print-report-btn');
        const statsContainer = document.getElementById('stats-container');
        const regionFilter = document.getElementById('region-filter');
        const statusTableContainer = document.getElementById('status-table-container');
        const chartCanvas = document.getElementById('inputChart');
        let inputChart = null; 

        // --- Fungsi Bantuan ---
        const setContainerLoading = (container) => {
            container.innerHTML = `<div class="text-center p-8"><i class="fas fa-spinner fa-spin text-3xl text-gray-500"></i><p class="mt-2">Memuat data...</p></div>`;
        };
        const setContainerError = (container, message) => {
            container.innerHTML = `<div class="text-center p-8 text-red-600"><i class="fas fa-exclamation-triangle text-3xl"></i><p class="mt-2 font-semibold">Gagal memuat data</p><p class="text-sm text-gray-500">${message}</p></div>`;
        };

        // --- Manajemen Tampilan ---
        function showView(viewName) {
            Object.keys(views).forEach(key => {
                views[key].classList.add('hidden-view');
                navButtons[key].classList.remove('active');
            });
            views[viewName].classList.remove('hidden-view');
            navButtons[viewName].classList.add('active');
        }

        // --- Event Listeners untuk Navigasi ---
        navButtons.form.addEventListener('click', () => showView('form'));
        navButtons.report.addEventListener('click', () => {
            showView('report');
            fetchObservationReport(regionFilter.value);
        });
        navButtons.stats.addEventListener('click', () => {
            showView('stats');
            updateInputStatusAndChart();
            fetchRegionalStats();
        });

        // --- Logika Statistik & Laporan ---
        function updateInputStatusAndChart() {
            setContainerLoading(statusTableContainer);
            if (inputChart) { inputChart.destroy(); }
            const allRegions = Array.from(document.querySelectorAll('#kota_kabupaten option')).filter(opt => opt.value !== '').map(opt => opt.value);
            fetch(`${scriptURL}?view=get_regions`).then(res => res.json()).then(submittedRegions => {
                if (submittedRegions.error) throw new Error(submittedRegions.error);
                const belumInputRegions = allRegions.filter(region => !submittedRegions.includes(region));
                const sudahInputRegions = submittedRegions;
                let tableHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <div><h3 class="text-lg font-semibold text-green-600 mb-3"><i class="fas fa-check-circle mr-2"></i>Daerah Sudah Input (${sudahInputRegions.length})</h3><ul class="space-y-2">${sudahInputRegions.map(r => `<li class="p-2 bg-green-50 rounded-md text-sm">${r}</li>`).join('') || `<li class="text-gray-500">Belum ada</li>`}</ul></div>
                    <div><h3 class="text-lg font-semibold text-red-600 mb-3"><i class="fas fa-times-circle mr-2"></i>Daerah Belum Input (${belumInputRegions.length})</h3><ul class="space-y-2">${belumInputRegions.map(r => `<li class="p-2 bg-red-50 rounded-md text-sm">${r}</li>`).join('') || `<li class="text-gray-500">Semua sudah input</li>`}</ul></div>
                </div>`;
                statusTableContainer.innerHTML = tableHTML;
                const ctx = chartCanvas.getContext('2d');
                inputChart = new Chart(ctx, { type: 'doughnut', data: { labels: ['Sudah Input', 'Belum Input'], datasets: [{ label: 'Status Input Daerah', data: [sudahInputRegions.length, belumInputRegions.length], backgroundColor: ['rgb(34, 197, 94)', 'rgb(239, 68, 68)'], hoverOffset: 4 }] }, options: { responsive: true, plugins: { legend: { position: 'top' }, title: { display: true, text: 'Perbandingan Daerah Sudah vs Belum Input' } } } });
            }).catch(err => setContainerError(statusTableContainer, err.message));
        }
        function fetchRegionalStats() {
            setContainerLoading(statsContainer);
            fetch(`${scriptURL}?view=regional_stats`).then(res => res.json()).then(data => {
                if (data.error) throw new Error(data.error);
                let tableHTML = `<table class="w-full text-sm">
                    <thead class="bg-gray-100"><tr><th>Nama Daerah</th><th class="text-center">Jumlah Input</th><th class="text-center">Rata-rata Kelengkapan</th></tr></thead><tbody>`;
                if (data.length === 0) { tableHTML += `<tr><td colspan="3" class="text-center py-4">Belum ada data yang masuk.</td></tr>`; } 
                else { data.forEach(item => { tableHTML += `<tr><td class="font-medium">${item.nama_daerah}</td><td class="text-center">${item.input}</td><td class="text-center">${item.persentase}%</td></tr>`; }); }
                statsContainer.innerHTML = tableHTML + `</tbody></table>`;
            }).catch(err => setContainerError(statsContainer, err.message));
        }
        function populateRegionDropdown() {
            fetch(`${scriptURL}?view=get_regions`).then(res => res.json()).then(regions => {
                if (regions.error) throw new Error(regions.error);
                regionFilter.innerHTML = '<option value="semua">Semua Daerah</option>';
                regions.forEach(region => { const option = document.createElement('option'); option.value = region; option.textContent = region; regionFilter.appendChild(option); });
            }).catch(err => console.error("Gagal memuat daftar daerah:", err));
        }
        
        function fetchObservationReport(region = 'semua') {
            setContainerLoading(reportContentWrapper);
            printReportBtn.classList.add('hidden');
            const url = `${scriptURL}?view=summary&region=${encodeURIComponent(region)}`;
            fetch(url).then(res => res.json()).then(data => {
                if (data.error) {
                    reportContentWrapper.innerHTML = `<div class="text-center p-8 text-gray-500">${data.error}</div>`;
                    return;
                }
                
                const { summary, details } = data;

                let totalSubmissions = 0;
                if (Object.keys(summary).length > 0) {
                    totalSubmissions = Math.max(0, ...Object.values(summary).map(
                        item => (item.ya || 0) + (item.tidak || 0) + (item.tidakOptimal || 0)
                    ));
                }
                
                const createInfoRow = (label, items) => {
                    if (!items || (Array.isArray(items) && items.length === 0)) return '';
                    const displayValue = Array.isArray(items) ? items.join(', ') : items;
                    return `
                        <div class="font-semibold">${label}</div>
                        <div>: ${displayValue}</div>
                    `;
                };

                const infoHTML = `
                    <div class="mb-8 border-b pb-6 hidden print:block">
                        <h3 class="text-xl font-semibold text-gray-700 mb-4">Informasi Laporan Agregat</h3>
                        <div class="grid grid-cols-[max-content,1fr] gap-x-4 gap-y-2 text-gray-800 text-sm">
                            ${createInfoRow('Daerah Laporan', region === 'semua' ? 'Nasional (Semua Daerah)' : region)}
                            ${createInfoRow('Jumlah Data Masuk', `${totalSubmissions} Laporan`)}
                            ${createInfoRow('Petugas Supervisi', details.petugas)}
                            ${createInfoRow('Responden', details.responden)}
                            ${createInfoRow('Satuan Pendidikan', details.satuanPendidikan)}
                            ${createInfoRow('Kepala Sekolah', details.kepalaSekolah)}
                        </div>
                    </div>
                `;

                let tableHTML;
                if (totalSubmissions === 0) {
                    tableHTML = `<div class="text-center p-8 text-gray-500">Belum ada data observasi untuk daerah ini.</div>`;
                    printReportBtn.classList.add('hidden');
                } else {
                    tableHTML = `<div class="overflow-x-auto"><table class="w-full text-sm">
                        <thead class="bg-gray-100"><tr><th class="w-1/3">Pertanyaan</th><th class="text-center">Ya</th><th class="text-center">Tidak</th><th class="text-center">Tidak Optimal</th><th>Catatan Tambahan</th></tr></thead><tbody>`;
                    for (const question in summary) {
                        const item = summary[question];
                        const notesHTML = item.catatan.map(note => `<li class="list-disc ml-4">${note}</li>`).join('');
                        tableHTML += `<tr><td class="font-medium">${question}</td><td class="text-center">${item.ya}</td><td class="text-center">${item.tidak}</td><td class="text-center">${item.tidakOptimal}</td><td><ul class="space-y-1">${notesHTML || 'Tidak ada'}</ul></td></tr>`;
                    }
                    tableHTML += `</tbody></table></div>`;
                    printReportBtn.classList.remove('hidden');
                }
                
                reportContentWrapper.innerHTML = infoHTML + tableHTML;

            }).catch(err => setContainerError(reportContentWrapper, err.message));
        }

        regionFilter.addEventListener('change', () => fetchObservationReport(regionFilter.value));
        printReportBtn.addEventListener('click', () => {
            document.body.classList.add('print-aggregated-report');
            window.print();
            document.body.classList.remove('print-aggregated-report');
        });

        // --- Logika Modal & Pratinjau Cetak Individual ---
        function showModal(type, title, message, printData = null) {
            const modal = document.getElementById('responseModal'), modalContent = modal.querySelector('.modal-content'), modalIcon = document.getElementById('modal-icon'), modalTitle = document.getElementById('modal-title'), modalMessage = document.getElementById('modal-message'), printPreviewBtn = document.getElementById('modal-print-preview-btn');
            modalIcon.innerHTML = type === 'success' ? `<i class="fas fa-check text-4xl text-green-500"></i>` : `<i class="fas fa-times text-4xl text-red-500"></i>`;
            modalIcon.className = `mx-auto flex items-center justify-center h-16 w-16 rounded-full mb-4 ${type === 'success' ? 'bg-green-100' : 'bg-red-100'}`;
            modalTitle.textContent = title; modalMessage.textContent = message;
            if (type === 'success' && printData) {
                printPreviewBtn.classList.remove('hidden');
                printPreviewBtn.onclick = () => { hideModal(); setTimeout(() => displayPrintPreview(printData), 300); };
            } else {
                printPreviewBtn.classList.add('hidden'); printPreviewBtn.onclick = null;
            }
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modalContent.classList.remove('scale-95'); }, 10);
        }
        function hideModal() {
            const modal = document.getElementById('responseModal'), modalContent = modal.querySelector('.modal-content');
            modal.classList.add('opacity-0'); modalContent.classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        }
        document.getElementById('modal-close').addEventListener('click', hideModal);

        function displayPrintPreview(data) {
            const contentArea = document.getElementById('print-content-area');
            const modal = document.getElementById('printPreviewModal');
            const dataMap = reportHeaders.map((header, index) => ({ label: header, value: data[index] || 'N/A' }));
            
            const renderSection = (title, startIndex, endIndex) => {
                let itemsHtml = '';
                for (let i = startIndex; i < endIndex; i++) {
                    if (dataMap[i+1] && dataMap[i+1].label.includes('Catatan Tambahan')) {
                         itemsHtml += `<div class="print-item print-item-grouped"><div class="print-item-label">${dataMap[i].label}</div><div class="print-item-value"><p class="font-semibold">${dataMap[i].value}</p><p class="text-sm text-gray-600 mt-2"><strong>Catatan:</strong> ${dataMap[i+1].value !== 'N/A' && dataMap[i+1].value ? dataMap[i+1].value : '<em>Tidak ada catatan</em>'}</p></div></div>`;
                        i++; 
                    } else { itemsHtml += `<div class="print-item"><div class="print-item-label">${dataMap[i].label}</div><div class="print-item-value">${dataMap[i].value}</div></div>`; }
                }
                return `<div class="print-section"><h4 class="print-section-title">${title}</h4>${itemsHtml}</div>`;
            };

            let timestamp = new Date(dataMap[0].value).toLocaleString('id-ID', { dateStyle: 'full', timeStyle: 'long'});
            contentArea.innerHTML = `
                <div class="text-center mb-8"><h2 class="text-2xl font-bold">Laporan Hasil Observasi</h2><p class="text-gray-500">Waktu Input: ${timestamp}</p></div>
                <div class="print-section"><h4 class="print-section-title">Informasi Umum</h4>
                    <div class="print-item"><div class="print-item-label">Kota/Kabupaten</div><div class="print-item-value">${dataMap[1].value}</div></div>
                    <div class="print-item"><div class="print-item-label">Nama Satuan Pendidikan</div><div class="print-item-value">${dataMap[5].value}</div></div>
                    <div class="print-item"><div class="print-item-label">Alamat Satuan Pendidikan</div><div class="print-item-value">${dataMap[6].value}</div></div>
                </div>
                <div class="print-section"><h4 class="print-section-title">Detail Responden & Petugas</h4>
                    <div class="print-item"><div class="print-item-label">Nama Petugas Supervisi</div><div class="print-item-value">${dataMap[2].value}</div></div>
                    <div class="print-item"><div class="print-item-label">No. HP Petugas</div><div class="print-item-value">${dataMap[3].value}</div></div>
                    <div class="print-item"><div class="print-item-label">Nama Responden</div><div class="print-item-value">${dataMap[4].value}</div></div>
                    <div class="print-item"><div class="print-item-label">Nama Kepala Sekolah</div><div class="print-item-value">${dataMap[7].value}</div></div>
                    <div class="print-item"><div class="print-item-label">No. HP Kepala Sekolah</div><div class="print-item-value">${dataMap[8].value}</div></div>
                </div>
                ${renderSection('Hasil Observasi: Akses', 9, 19)}
                ${renderSection('Hasil Observasi: Mutu', 19, 29)}
                ${renderSection('Hasil Observasi: Tata Kelola', 29, 39)}
            `;
            modal.classList.remove('hidden');
            setTimeout(() => { modal.classList.remove('opacity-0'); modal.querySelector('.modal-content').classList.remove('scale-95'); }, 10);
        }
        document.getElementById('print-button').addEventListener('click', () => {
             document.body.classList.add('print-individual-report');
             window.print();
             document.body.classList.remove('print-individual-report');
        });
        document.getElementById('print-modal-close').addEventListener('click', () => {
            const modal = document.getElementById('printPreviewModal');
            modal.classList.add('opacity-0');
            modal.querySelector('.modal-content').classList.add('scale-95');
            setTimeout(() => modal.classList.add('hidden'), 300);
        });

        // --- Logika Form ---
        function updateButtonVisibility() {
            prevButton.classList.toggle('hidden', currentSectionIndex === 0);
            nextButton.classList.toggle('hidden', currentSectionIndex === allSections.length - 1);
            submitButton.classList.toggle('hidden', currentSectionIndex !== allSections.length - 1);
        }
        function showSection(index) {
            allSections.forEach((s, i) => s.classList.toggle('hidden', i !== index));
            updateButtonVisibility(); window.scrollTo(0, 0);
        }
        function validateCurrentSection() {
            for (const i of allSections[currentSectionIndex].querySelectorAll('[required]')) { if (!i.checkValidity()) return false; }
            return true;
        }
        nextButton.addEventListener('click', () => { if (validateCurrentSection()) { currentSectionIndex++; showSection(currentSectionIndex); } else { form.reportValidity(); } });
        prevButton.addEventListener('click', () => { currentSectionIndex--; showSection(currentSectionIndex); });
        
        function generateQuestions() {
            const sections = { akses: { b: 'border-blue-500', h: '' }, mutu: { b: 'border-purple-500', h: '' }, tata_kelola: { b: 'border-green-500', h: '' } };
            for (let i = 0; i < masterData.length; i++) {
                const field = masterData[i];
                if (field.type === 'radio') {
                    const noteField = masterData[i + 1]; const sectionName = field.id.split('_').slice(0, -1).join('_');
					const sData = sections[sectionName];
                    if (sData) sData.h += `<div class="bg-gray-50 p-4 rounded-lg border"><p class="font-medium text-gray-700 mb-2">${field.text}</p><div class="flex flex-wrap items-center gap-x-6 gap-y-2 mb-3">${['Ya','Tidak','Tidak Optimal'].map(o=>`<label class="flex items-center space-x-2 cursor-pointer"><input type="radio" name="${field.id}" value="${o}" class="h-4 w-4 text-teal-600" required><span>${o}</span></label>`).join('')}</div><label class="block text-sm font-medium text-gray-600 mb-1">Catatan Tambahan</label><textarea name="${noteField.id}" rows="2" class="w-full px-3 py-2 border rounded-md"></textarea></div>`;
                }
            }
            questionContainer.innerHTML = `<fieldset class="form-section border-t-4 ${sections.akses.b} pt-6"><legend class="text-xl font-semibold text-gray-700 px-2">AKSES</legend><div class="space-y-6 mt-4">${sections.akses.h}</div></fieldset><fieldset class="form-section border-t-4 ${sections.mutu.b} pt-6"><legend class="text-xl font-semibold text-gray-700 px-2">MUTU</legend><div class="space-y-6 mt-4">${sections.mutu.h}</div></fieldset><fieldset class="form-section border-t-4 ${sections.tata_kelola.b} pt-6"><legend class="text-xl font-semibold text-gray-700 px-2">TATA KELOLA</legend><div class="space-y-6 mt-4">${sections.tata_kelola.h}</div></fieldset>`;
        }
        function initializeForm() { generateQuestions(); allSections = document.querySelectorAll('.form-section'); showSection(0); }
        form.addEventListener('submit', e => {
            e.preventDefault(); if(!validateCurrentSection()){ form.reportValidity(); return; }
            submitButton.disabled = true; buttonText.textContent = 'Mengirim...'; loadingSpinner.classList.remove('hidden');
            const rowData = masterData.map(f => { const el = form.elements[f.id]; return (el instanceof RadioNodeList) ? el.value || "" : el.value || ""; });
            fetch(scriptURL, { method: 'POST', body: JSON.stringify(rowData), headers: { 'Content-Type': 'text/plain;charset=utf-8' }})
            .then(res => res.json()).then(data => { 
                if (data.result === "success") { 
                    form.reset(); currentSectionIndex = 0; showSection(0); 
                    showModal('success', 'Berhasil!', 'Data observasi Anda telah berhasil dikirim.', data.savedData); 
                    populateRegionDropdown(); updateInputStatusAndChart(); fetchRegionalStats();
                } else { throw new Error(data.message || 'Unknown error'); }
            })
            .catch(err => showModal('error', 'Gagal!', 'Gagal mengirim data: ' + err.message))
            .finally(() => { submitButton.disabled = false; buttonText.textContent = 'Kirim Data'; loadingSpinner.classList.add('hidden'); });
        });

        // --- Inisialisasi Awal ---
        initializeForm();
        populateRegionDropdown();
    });
    </script>
</body>
</html>

